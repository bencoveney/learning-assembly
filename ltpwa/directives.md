# Assembler Directives

| Syntax                          | Behaviour                                                                                           |
| ------------------------------- | --------------------------------------------------------------------------------------------------- |
| `.section [kind]`               | Preceeding region of instructions, for inclusion in a code section/segment.                         |
| `.globl [label]` (or `.global`) | Designate a label/constant as global. It will be exported/available to other files when assembling. |
| `.external [label]`             | Identify a label as being provided by another file. Has no effect, as GNU Assembler assumes this.   |
| `.equ [name], [value]`          | Creates a assembler-time constant with the given name. `value` can include some basic computation.  |
| `.type [name], [type]`          | Annotates a symbol with its type, e.g. `function`, `object`.                                        |
| `[label]:`                      | Define a label. Ends up just pointing to an address in memory.                                      |
| `.include "[file]"`             | Include a `[file]`. Included files shouldn't contain `.globl`.                                      |
| `.incbin "[file]"`              | Include a `[file]` verbatim as binary.                                                              |
| `.cfi_...`                      | Control flow integrity directives, tell debuggers about the intended flow.                          |
| `.file [file]`                  | Source file the assembly was generated from.                                                        |

Call frame information generated by GNU AS to for debugging and exception handling:

- `.cfi_startproc`
- `.cfi_endproc`
- `.cfi_offset`
- `.cfi_def_cfa`
- `.cfi_def_cfa_offset`
- `.cfi_def_cfa_register`

https://ftp.gnu.org/old-gnu/Manuals/gas-2.9.1/html_chapter/as_7.html

## Data Sections

```gas
label:
  .type value [, value, value...]
```

Can be read from and written to. Generally need to move values to registers to use/manipulate them.

### Section Types

| Directive          | Shorthand | Description                                        | Uses                                                   |
| ------------------ | --------- | -------------------------------------------------- | ------------------------------------------------------ |
| `.section .text`   | `.text`   | Code                                               | Code                                                   |
| `.section .data`   | `.data`   | Memory space and/or values, modifiable at run-time | Predefined global variables                            |
| `.section .rodata` |           | Memory space and/or values, read-only at run-time  | Predefined global constants                            |
| `.section .bss`    |           | Memory space, modifiable at run-time               | Reserving space without taking it up in the executable |

Examples:

```gas
.section .bss
mydata:
  .zero 1000

.section .rodata
myreadonlydata:
  .quad 7
```

### Common Areas

Shorthand for reserving space in the `.bss` section.

- `.lcomm [label], [bytes]` - Reserves `[bytes]` space as `[label]`, local to the current file, but can be marked `.globl`.
- `.comm [label], [bytes]` - Reserves `[bytes]` space as `[label]`, will be merged if also defined in other files.

## Data Types

| Directive        | Content               | Size                            |
| ---------------- | --------------------- | ------------------------------- |
| `.byte`          | Arbitrary             | 1 byte                          |
| `.2byte`         | Arbitrary             | 2 bytes                         |
| `.short`         | Arbitrary             | 2 bytes                         |
| `.4byte`         | Arbitrary             | 4 bytes                         |
| `.int`           | Int                   | 4 bytes                         |
| `.long`          | Int                   | 4 bytes                         |
| `.8byte`         | Int                   | 8 bytes                         |
| `.quad`          | Int                   | 8 bytes                         |
| `.single`        | Float                 | 4 Bytes                         |
| `.double`        | Float                 | 8 Bytes                         |
| `.skip [bytes]`  | Nothing               | Empty space with the given size |
| `.space [bytes]` | Nothing               | Empty space with the given size |
| `.zero [bytes]`  | Nothing               | Empty space with the given size |
| `.ascii`         | ASCII String          | Length of string, in bytes      |
| `.string`        | ASCII String + `null` | Length of string + 1, in bytes  |
| `.asciz`         | ASCII String + `null` | Length of string + 1, in bytes  |

## Data Alignment

Many instructions prefer (i.e. will be faster) working from data that is at an address which is
a multiple of the word size (e.g. 64 bits - 8 bytes).

Instuctions themselves can also prefer to be aligned, e.g. if they will be commonly jumped to.

Some instructions require alignment on the stack. Some vector instructions will require 16 byte
alignment. For these reasons, space on the stack is always reserved in multiples of 16 bytes.

Spacing will be `0` in a data section or `nop` in a code section.

| Directive             | Meaning                                                    | Example                                 |
| --------------------- | ---------------------------------------------------------- | --------------------------------------- |
| `.b2align [multiple]` | Align the next address to a multiple of `[multiple]` bytes | `.b2align 8` gives alignment to 8 bytes |
| `.p2align [exponent]` | Align the next address to `2^[exponent]` bytes             | `.p2align 3` gives alignment to 8 bytes |
| `.align`              | Probs avoid. Acts like `.b2align` most of the time         |                                         |

## Type Annotations

Can be helpful for debugging.

```gas
.globl myvar, myfunc
.type myvar, @object
.type myfunc, @function

.section .data
myvar:
  .quad 0

.section .text
myfunc:
  # ... Code ...
  ret
```
